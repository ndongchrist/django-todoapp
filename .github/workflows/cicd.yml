name: Deploy to VPS

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U test_user"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install virtualenv
          virtualenv venv
          source venv/bin/activate
          pip install -r requirements.txt

      - name: Wait for PostgreSQL to be Ready
        run: sleep 10

      - name: Run Migrations
        run: |
          source venv/bin/activate
          python manage.py migrate --noinput
        env:
          DB_NAME: test_db
          DB_USER: test_user
          DB_PASSWORD: test_password
          DB_HOST: localhost
          DB_PORT: 5432

      - name: Run Tests
        run: |
          source venv/bin/activate
          python manage.py test | tee test_report.txt

      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: test_report.txt

      - name: Set Deployment Details
        run: |
          echo "COMMIT_HASH=$(git log -1 --pretty=format:'%h')" >> $GITHUB_ENV
          echo "DATE=$(date)" >> $GITHUB_ENV
          echo "EMAIL=$(git log -1 --pretty=format:'%ae')" >> $GITHUB_ENV


      - name: Send Email Notification (Failure)
        if: failure()
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âŒ Ã‰chec des tests sur la CI/CD"
          to: "christianhonore2003@gmail.com" # Utilisation de l'email de l'auteur du commit # Utilisation de l'email de l'auteur du commit
          from: "CI/CD Pipeline"
          body: |
            Bonjour,

            â— Les tests automatiques ont Ã©chouÃ© sur la branche `master`. â— par ${{ env.EMAIL}}

            **DÃ©tails de l'Ã©chec :**
            - ğŸ·ï¸ Commit : ${{ env.COMMIT_HASH }}
            - ğŸ“… Date : ${{ env.DATE }}
            - ğŸ”— Repository : ${{ github.repository }}
            - ğŸ“‚ Branche : `master`
            - ğŸš¨ Par: ${{ env.EMAIL }}
            - ğŸš¨ Erreur : Consultez le rapport de test joint.

            Veuillez vÃ©rifier et corriger les erreurs avant de re-pusher le code.  

            **L'Ã©quipe DevOps**
          attachments: test_report.txt

  deploy:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          touch ~/.ssh/known_hosts
          ssh-keyscan -H ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

      - name: Debug SSH Connection
        run: ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -i ~/.ssh/id_rsa ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "echo 'âœ… SSH Connection Successful'"

      - name: SSH into VPS and Deploy
        run: |
          ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -i ~/.ssh/id_rsa ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} << 'EOF'
            set -e
            echo "ğŸš€ Starting Deployment..."
            
            cd /var/www/logiciel-analyse-psychiatrie-psychologie
            chmod +x deploy.sh
            
            echo "ğŸ“‚ Running deploy.sh in background..."
            nohup ./deploy.sh > deploy.log 2>&1 &

            echo "âœ… Deployment started successfully!"
          EOF


      - name: Set Deployment Details
        run: |
          echo "COMMIT_HASH=$(git log -1 --pretty=format:'%h')" >> $GITHUB_ENV
          echo "DATE=$(date)" >> $GITHUB_ENV
          echo "EMAIL=$(git log -1 --pretty=format:'%ae')" >> $GITHUB_ENV

      - name: Send Email Notification (Failure)
        if: failure()
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âŒ Ã‰chec des tests sur la CI/CD"
          to: "christianhonore2003@gmail.com" # Utilisation de l'email de l'auteur du commit
          from: "CI/CD Pipeline"
          body: |
            Bonjour,

            â— Les tests automatiques ont Ã©chouÃ© sur la branche `master`. â—

            **DÃ©tails de l'Ã©che par ${{ env.EMAIL}} :**
            - ğŸ·ï¸ Commit : ${{ env.COMMIT_HASH }}
            - ğŸ“… Date : ${{ env.DATE }}
            - ğŸ”— Repository : ${{ github.repository }}
            - ğŸ“‚ Branche : `master`
            - ğŸš¨ Par: ${{ env.EMAIL }}
            - ğŸš¨ Erreur : Consultez le rapport de test joint.

            Veuillez vÃ©rifier et corriger les erreurs avant de re-pusher le code.  

            **L'Ã©quipe DevOps**
          attachments: test_report.txt
          

      - name: Send Email Notification (Success)
        if: success()
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âœ… DÃ©ploiement RÃ©ussi ğŸš€"
          to: "christianhonore2003@gmail.com" # Utilisation de l'email de l'auteur du commit # Utilisation de l'email de l'auteur du commit
          from: "CI/CD Pipeline"
          body: |
            Bonjour,

            Le dÃ©ploiement de votre code sur la branche `master` a Ã©tÃ© effectuÃ© avec succÃ¨s ! ğŸ‰

            **DÃ©tails du dÃ©ploiement par ${{ env.EMAIL}} :**
            - ğŸ·ï¸ Commit : ${{  env.COMMIT_HASH }}
            - ğŸ“… Date : ${{ env.DATE }}
            - ğŸ”— Repository : ${{ github.repository }}
            - ğŸ“‚ Branche : `master`
            - ğŸ“Š by : ${{ env.EMAIL }}

            Merci pour votre contribution ! ğŸ‘

            **L'Ã©quipe DevOps**
          attachments: test_report.txt